package br.com.msansone.api.stockwebservice.ado;

import br.com.msansone.api.stockwebservice.model.*;
import com.google.gson.Gson;
import org.apache.http.HttpEntity;
import org.apache.http.client.methods.CloseableHttpResponse;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClients;
import org.apache.http.util.EntityUtils;

import java.io.IOException;
import java.math.BigDecimal;
import java.text.DateFormat;
import java.text.SimpleDateFormat;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.logging.Logger;
import java.util.stream.Collectors;


public class MarketStackWebAccess implements IWebAccess {

    static String URI_EOD = "http://api.marketstack.com/v1/eod?access_key=018df0cc07569cd1813ad0926ee63f97&symbols=";
    static String URI_TICKERS = "http://api.marketstack.com/v1/tickers?access_key=018df0cc07569cd1813ad0926ee63f97&symbols=";

    private static Logger LOG = Logger.getLogger("getStockData");
    CloseableHttpClient httpClient = HttpClients.createDefault();


    @Override
    public StockWebInfoResponse getStockInfoData(String code) throws IOException {

        StockWebInfoResponse retorno = new StockWebInfoResponse();

        code = code + ".BVMF";
        HttpGet request = new HttpGet(URI_TICKERS + code);
        CloseableHttpResponse response = httpClient.execute(request);
        HttpEntity entity = response.getEntity();

        String result = EntityUtils.toString(entity);
        LOG.info(result);
        Gson gson = new Gson();
        JsonEntityTickers tic = gson.fromJson(result, JsonEntityTickers.class);

        LOG.info("symbol=" + tic.getPagination().getLimit());
        LOG.info("symbol=" + tic.getData().get(0).getName());

        retorno.setCode(code);
        retorno.setName(tic.getData().get(0).getName());
        retorno.setStockExchangeAcronym(tic.getData().get(0).getStock_exchange().getAcronym());
        retorno.setStockExchangeContryCode(tic.getData().get(0).getStock_exchange().getCountry_code());
        retorno.setStockExchangeContry(tic.getData().get(0).getStock_exchange().getCountry());
        retorno.setStockExchangeName(tic.getData().get(0).getStock_exchange().getName());
        retorno.setStockExchangeMic(tic.getData().get(0).getStock_exchange().getMic());

        return retorno;
    }

    @Override
    public StockWebValResponse getStockValData(String code, LocalDate date) throws IOException {

        String result="";
        StockWebValResponse retorno = new StockWebValResponse();
        if (date==null) {
            date= LocalDate.now();
        }

        code = code + ".BVMF";
        HttpGet request = new HttpGet(URI_EOD + code);
        CloseableHttpResponse response = httpClient.execute(request);
        HttpEntity entity = response.getEntity();
        result = EntityUtils.toString(entity);

     //   result = "{\"pagination\":{\"limit\":100,\"offset\":0,\"count\":100,\"total\":248},\"data\":[{\"open\":95.61,\"high\":95.9,\"low\":95.0,\"close\":95.26,\"volume\":17687.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":95.26,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-12-01T00:00:00+0000\"},{\"open\":96.44,\"high\":96.6,\"low\":95.3,\"close\":95.75,\"volume\":13809.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":95.75,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-30T00:00:00+0000\"},{\"open\":96.17,\"high\":96.76,\"low\":96.0,\"close\":96.45,\"volume\":9867.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.45,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-27T00:00:00+0000\"},{\"open\":95.52,\"high\":96.74,\"low\":95.52,\"close\":96.51,\"volume\":8530.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.51,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-26T00:00:00+0000\"},{\"open\":96.53,\"high\":96.96,\"low\":95.52,\"close\":95.87,\"volume\":21462.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":95.87,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-25T00:00:00+0000\"},{\"open\":96.7,\"high\":96.9,\"low\":96.5,\"close\":96.5,\"volume\":16031.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.5,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-24T00:00:00+0000\"},{\"open\":96.76,\"high\":97.0,\"low\":96.7,\"close\":96.89,\"volume\":14218.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.89,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-23T00:00:00+0000\"},{\"open\":96.77,\"high\":97.15,\"low\":96.75,\"close\":96.76,\"volume\":10949.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.76,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-20T00:00:00+0000\"},{\"open\":96.76,\"high\":96.95,\"low\":96.75,\"close\":96.93,\"volume\":12217.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.93,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-19T00:00:00+0000\"},{\"open\":96.8,\"high\":96.98,\"low\":96.75,\"close\":96.95,\"volume\":13382.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.95,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-18T00:00:00+0000\"},{\"open\":96.78,\"high\":97.15,\"low\":96.75,\"close\":96.8,\"volume\":13703.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.8,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-17T00:00:00+0000\"},{\"open\":96.76,\"high\":97.13,\"low\":96.75,\"close\":96.77,\"volume\":12238.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.77,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-16T00:00:00+0000\"},{\"open\":97.0,\"high\":97.5,\"low\":96.63,\"close\":97.05,\"volume\":13318.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.05,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-13T00:00:00+0000\"},{\"open\":97.3,\"high\":97.53,\"low\":96.5,\"close\":96.75,\"volume\":8516.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.75,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-12T00:00:00+0000\"},{\"open\":98.49,\"high\":98.78,\"low\":97.63,\"close\":97.8,\"volume\":11560.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.8,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-11T00:00:00+0000\"},{\"open\":98.35,\"high\":98.78,\"low\":97.64,\"close\":98.49,\"volume\":17552.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.49,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-10T00:00:00+0000\"},{\"open\":96.71,\"high\":98.8,\"low\":96.71,\"close\":98.35,\"volume\":15659.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.35,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-09T00:00:00+0000\"},{\"open\":96.35,\"high\":96.97,\"low\":96.11,\"close\":96.62,\"volume\":24664.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.62,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-06T00:00:00+0000\"},{\"open\":97.11,\"high\":97.11,\"low\":96.4,\"close\":96.67,\"volume\":16752.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.67,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-05T00:00:00+0000\"},{\"open\":96.3,\"high\":97.4,\"low\":96.11,\"close\":96.65,\"volume\":15224.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.65,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-04T00:00:00+0000\"},{\"open\":96.0,\"high\":96.87,\"low\":95.25,\"close\":96.3,\"volume\":35801.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.3,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-11-03T00:00:00+0000\"},{\"open\":98.04,\"high\":98.56,\"low\":96.33,\"close\":97.65,\"volume\":21706.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.65,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-30T00:00:00+0000\"},{\"open\":96.51,\"high\":98.12,\"low\":94.69,\"close\":98.04,\"volume\":19144.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.04,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-29T00:00:00+0000\"},{\"open\":98.0,\"high\":98.0,\"low\":96.47,\"close\":96.51,\"volume\":15543.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.51,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-28T00:00:00+0000\"},{\"open\":98.4,\"high\":98.54,\"low\":97.89,\"close\":98.05,\"volume\":13785.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.05,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-27T00:00:00+0000\"},{\"open\":99.56,\"high\":99.88,\"low\":98.07,\"close\":98.11,\"volume\":16966.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.11,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-26T00:00:00+0000\"},{\"open\":99.6,\"high\":99.92,\"low\":99.18,\"close\":99.2,\"volume\":19283.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.2,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-23T00:00:00+0000\"},{\"open\":99.88,\"high\":100.0,\"low\":99.4,\"close\":99.6,\"volume\":10967.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.6,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-22T00:00:00+0000\"},{\"open\":99.42,\"high\":100.42,\"low\":99.42,\"close\":99.53,\"volume\":14591.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.53,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-21T00:00:00+0000\"},{\"open\":100.95,\"high\":101.39,\"low\":98.5,\"close\":99.4,\"volume\":20288.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.4,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-20T00:00:00+0000\"},{\"open\":102.0,\"high\":102.0,\"low\":100.65,\"close\":100.98,\"volume\":21417.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.98,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-19T00:00:00+0000\"},{\"open\":101.4,\"high\":102.7,\"low\":100.75,\"close\":102.04,\"volume\":35514.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":102.04,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-16T00:00:00+0000\"},{\"open\":101.08,\"high\":101.5,\"low\":100.57,\"close\":101.4,\"volume\":34259.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.4,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-15T00:00:00+0000\"},{\"open\":100.58,\"high\":101.45,\"low\":100.5,\"close\":100.9,\"volume\":14152.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.9,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-14T00:00:00+0000\"},{\"open\":100.61,\"high\":101.37,\"low\":100.4,\"close\":100.58,\"volume\":14432.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.58,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-13T00:00:00+0000\"},{\"open\":101.27,\"high\":101.5,\"low\":101.0,\"close\":101.5,\"volume\":17222.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.5,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-09T00:00:00+0000\"},{\"open\":100.85,\"high\":101.49,\"low\":100.76,\"close\":101.49,\"volume\":14262.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.49,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-08T00:00:00+0000\"},{\"open\":100.04,\"high\":101.1,\"low\":99.8,\"close\":100.85,\"volume\":17219.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.85,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-07T00:00:00+0000\"},{\"open\":98.69,\"high\":100.78,\"low\":98.69,\"close\":100.03,\"volume\":17694.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.03,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-06T00:00:00+0000\"},{\"open\":99.43,\"high\":99.79,\"low\":98.4,\"close\":98.67,\"volume\":22122.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.67,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-05T00:00:00+0000\"},{\"open\":100.0,\"high\":100.78,\"low\":97.75,\"close\":99.17,\"volume\":21667.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.17,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-02T00:00:00+0000\"},{\"open\":99.86,\"high\":101.6,\"low\":98.5,\"close\":99.19,\"volume\":24032.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.19,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-10-01T00:00:00+0000\"},{\"open\":100.4,\"high\":100.6,\"low\":99.12,\"close\":99.7,\"volume\":19473.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.7,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-30T00:00:00+0000\"},{\"open\":100.0,\"high\":100.12,\"low\":99.7,\"close\":99.7,\"volume\":11041.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.7,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-29T00:00:00+0000\"},{\"open\":100.49,\"high\":100.53,\"low\":99.5,\"close\":99.99,\"volume\":20208.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.99,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-28T00:00:00+0000\"},{\"open\":101.24,\"high\":101.24,\"low\":99.8,\"close\":99.81,\"volume\":16004.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.81,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-25T00:00:00+0000\"},{\"open\":100.89,\"high\":101.19,\"low\":100.54,\"close\":100.62,\"volume\":7775.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.62,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-24T00:00:00+0000\"},{\"open\":100.89,\"high\":101.75,\"low\":100.28,\"close\":100.89,\"volume\":10603.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.89,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-23T00:00:00+0000\"},{\"open\":99.7,\"high\":100.89,\"low\":99.7,\"close\":100.67,\"volume\":8745.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.67,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-22T00:00:00+0000\"},{\"open\":99.99,\"high\":100.63,\"low\":99.02,\"close\":99.7,\"volume\":12236.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.7,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-21T00:00:00+0000\"},{\"open\":101.2,\"high\":101.35,\"low\":99.91,\"close\":99.92,\"volume\":21641.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.92,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-18T00:00:00+0000\"},{\"open\":101.09,\"high\":101.2,\"low\":100.31,\"close\":101.0,\"volume\":17158.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-17T00:00:00+0000\"},{\"open\":100.5,\"high\":101.39,\"low\":100.4,\"close\":101.0,\"volume\":11764.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-16T00:00:00+0000\"},{\"open\":99.69,\"high\":100.31,\"low\":99.65,\"close\":100.31,\"volume\":13701.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.31,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-15T00:00:00+0000\"},{\"open\":99.0,\"high\":99.72,\"low\":98.71,\"close\":99.65,\"volume\":11626.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.65,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-14T00:00:00+0000\"},{\"open\":99.5,\"high\":99.9,\"low\":98.72,\"close\":98.96,\"volume\":13732.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.96,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-11T00:00:00+0000\"},{\"open\":99.86,\"high\":100.0,\"low\":99.73,\"close\":100.0,\"volume\":14690.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-10T00:00:00+0000\"},{\"open\":100.7,\"high\":100.96,\"low\":99.52,\"close\":99.9,\"volume\":17129.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.9,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-08T00:00:00+0000\"},{\"open\":101.48,\"high\":101.97,\"low\":100.51,\"close\":100.6,\"volume\":13018.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.6,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-04T00:00:00+0000\"},{\"open\":100.5,\"high\":101.48,\"low\":100.5,\"close\":101.48,\"volume\":14696.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.48,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-03T00:00:00+0000\"},{\"open\":101.49,\"high\":101.49,\"low\":99.9,\"close\":101.0,\"volume\":18926.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-02T00:00:00+0000\"},{\"open\":99.5,\"high\":101.09,\"low\":99.25,\"close\":101.09,\"volume\":20466.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.09,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-09-01T00:00:00+0000\"},{\"open\":99.0,\"high\":100.0,\"low\":98.04,\"close\":100.0,\"volume\":12542.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":100.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-31T00:00:00+0000\"},{\"open\":99.49,\"high\":99.69,\"low\":98.7,\"close\":99.1,\"volume\":10301.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.1,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-28T00:00:00+0000\"},{\"open\":99.95,\"high\":99.95,\"low\":98.42,\"close\":99.0,\"volume\":12415.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-27T00:00:00+0000\"},{\"open\":99.7,\"high\":99.98,\"low\":99.47,\"close\":99.72,\"volume\":10044.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.72,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-26T00:00:00+0000\"},{\"open\":99.13,\"high\":99.99,\"low\":99.13,\"close\":99.99,\"volume\":15588.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.99,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-25T00:00:00+0000\"},{\"open\":97.88,\"high\":99.5,\"low\":97.88,\"close\":99.13,\"volume\":11624.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.13,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-24T00:00:00+0000\"},{\"open\":97.97,\"high\":98.38,\"low\":97.29,\"close\":98.13,\"volume\":9567.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.13,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-21T00:00:00+0000\"},{\"open\":97.2,\"high\":97.83,\"low\":97.02,\"close\":97.61,\"volume\":11723.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.61,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-20T00:00:00+0000\"},{\"open\":97.31,\"high\":97.89,\"low\":96.8,\"close\":97.2,\"volume\":15493.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.2,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-19T00:00:00+0000\"},{\"open\":97.49,\"high\":97.98,\"low\":97.15,\"close\":97.67,\"volume\":16395.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.67,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-18T00:00:00+0000\"},{\"open\":97.12,\"high\":97.51,\"low\":97.12,\"close\":97.37,\"volume\":11677.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.37,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-17T00:00:00+0000\"},{\"open\":98.08,\"high\":98.65,\"low\":97.1,\"close\":97.12,\"volume\":18403.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.12,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-14T00:00:00+0000\"},{\"open\":98.52,\"high\":99.39,\"low\":97.65,\"close\":98.52,\"volume\":14377.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.52,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-13T00:00:00+0000\"},{\"open\":98.0,\"high\":99.75,\"low\":97.52,\"close\":99.2,\"volume\":29593.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.2,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-12T00:00:00+0000\"},{\"open\":99.14,\"high\":99.29,\"low\":98.06,\"close\":98.36,\"volume\":17551.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.36,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-11T00:00:00+0000\"},{\"open\":99.25,\"high\":99.5,\"low\":98.01,\"close\":99.1,\"volume\":12882.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.1,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-10T00:00:00+0000\"},{\"open\":96.52,\"high\":99.21,\"low\":96.5,\"close\":99.2,\"volume\":19417.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.2,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-07T00:00:00+0000\"},{\"open\":98.3,\"high\":98.77,\"low\":96.15,\"close\":96.5,\"volume\":20326.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":96.5,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-06T00:00:00+0000\"},{\"open\":98.01,\"high\":98.2,\"low\":97.67,\"close\":98.19,\"volume\":14094.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.19,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-05T00:00:00+0000\"},{\"open\":98.4,\"high\":98.49,\"low\":97.5,\"close\":98.01,\"volume\":17986.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.01,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-04T00:00:00+0000\"},{\"open\":99.2,\"high\":99.25,\"low\":97.9,\"close\":97.91,\"volume\":28332.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.91,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-08-03T00:00:00+0000\"},{\"open\":99.0,\"high\":99.6,\"low\":99.0,\"close\":99.29,\"volume\":13885.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.29,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-31T00:00:00+0000\"},{\"open\":99.0,\"high\":100.0,\"low\":98.93,\"close\":99.6,\"volume\":15424.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.6,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-30T00:00:00+0000\"},{\"open\":98.65,\"high\":99.0,\"low\":98.21,\"close\":99.0,\"volume\":11424.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.0,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-29T00:00:00+0000\"},{\"open\":97.7,\"high\":98.68,\"low\":97.67,\"close\":98.51,\"volume\":15110.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.51,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-28T00:00:00+0000\"},{\"open\":98.04,\"high\":98.47,\"low\":97.67,\"close\":97.7,\"volume\":16174.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.7,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-27T00:00:00+0000\"},{\"open\":97.98,\"high\":98.6,\"low\":97.67,\"close\":98.04,\"volume\":14590.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.04,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-24T00:00:00+0000\"},{\"open\":98.64,\"high\":98.65,\"low\":97.87,\"close\":97.95,\"volume\":20581.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":97.95,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-23T00:00:00+0000\"},{\"open\":98.5,\"high\":98.82,\"low\":98.48,\"close\":98.7,\"volume\":17042.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.7,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-22T00:00:00+0000\"},{\"open\":98.24,\"high\":98.96,\"low\":98.0,\"close\":98.15,\"volume\":12680.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.15,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-21T00:00:00+0000\"},{\"open\":99.16,\"high\":99.4,\"low\":98.02,\"close\":98.24,\"volume\":23690.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":98.24,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-20T00:00:00+0000\"},{\"open\":99.48,\"high\":99.48,\"low\":98.61,\"close\":99.15,\"volume\":16073.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.15,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-17T00:00:00+0000\"},{\"open\":99.0,\"high\":99.62,\"low\":98.7,\"close\":99.01,\"volume\":15702.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.01,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-16T00:00:00+0000\"},{\"open\":99.85,\"high\":99.95,\"low\":98.5,\"close\":99.54,\"volume\":17013.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.54,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-15T00:00:00+0000\"},{\"open\":99.97,\"high\":100.0,\"low\":99.42,\"close\":99.86,\"volume\":10896.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.86,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-14T00:00:00+0000\"},{\"open\":100.0,\"high\":100.39,\"low\":98.06,\"close\":99.98,\"volume\":19419.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":99.98,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-13T00:00:00+0000\"},{\"open\":100.62,\"high\":101.99,\"low\":99.18,\"close\":101.09,\"volume\":24008.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":101.09,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-10T00:00:00+0000\"},{\"open\":102.2,\"high\":102.77,\"low\":102.01,\"close\":102.37,\"volume\":13970.0,\"adj_high\":null,\"adj_low\":null,\"adj_close\":102.37,\"adj_open\":null,\"adj_volume\":null,\"symbol\":\"RBRR11.BVMF\",\"exchange\":\"BVMF\",\"date\":\"2020-07-09T00:00:00+0000\"}]}";


        LOG.info(result);
        Gson gson = new Gson();
        JsonEntityEOD tic = gson.fromJson(result, JsonEntityEOD.class);

        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");
        LocalDateTime agora = LocalDateTime.of(LocalDate.now(), LocalDateTime.MIN.toLocalTime());
        agora=agora.minusDays(1);
        LOG.info("agora = "+agora);
        String formattedDate = agora.format(formatter)+"+0000";
        LOG.info("formattedDate="+formattedDate);

        List<JEStockValue> data =null;
        if (tic.getError()!=null){
            retorno.setError(
                    new JEError(tic.getError().getCode(),
                            tic.getError().getMessage()));
        } else {
            data = tic.getData()
                    .stream()
                    .filter(d -> d.getDate().equals(formattedDate))
                    .collect(Collectors.toList());

            if (data.size()>0) {
                retorno.setValClose(data.get(0).getClose());
                retorno.setValHigh(data.get(0).getHigh());
                retorno.setValOpen(data.get(0).getOpen());
                retorno.setValLow(data.get(0).getLow());
            }
        }
        retorno.setCode(code);
        retorno.setDate(date);

        return retorno;
    }
}
